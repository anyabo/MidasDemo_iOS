Midas聚合广告SDK说明
--

版本号|更新时间|更新说明|包体积
---|---|---|---
V1.0.0|2020/01/06|1、添加穿山甲v2.5.1.5、优量汇v4.10.19、牛数v1.2.2库 <br>2、封装广告，提供统一调用接口|3.2M
V1.1.0|2020/01/18|1、添加串行缓存<br>2、新增Mobvista 激励视频|5.4M
v1.1.1|2020/02/22|1、新增实时标签(省、市、机型)<br>2、串并行逻辑开发<br>3、预缓存功能添加|5.4M
V1.2.0|2020/03/05|1、拆分Midas SDK，依赖库见接入文档<br>2、升级穿山甲 v2.7.5.2、优量汇 v4.11.5、牛数 v1.2.5.1<br>3、新增Topmob dsp广告|6M
V1.3.0|2020/03/13|1、接入推啊浮标SDK类型<br>2、统一andorid接口|6.3M
V1.3.1|2020/03/23|1、Inmobi开屏、原生自渲染广告<br>2、Mobvista广告接入|8M

说明：1.3.1版本聚合SDK支持如下广告类型

广告源|开屏|模板banner|模板插屏|模板全屏视频|模板激励视频|原生模板|自渲染|悬浮
---|---|---|---|---|---|---|---|---
穿山甲|√|√|√|√|√|√|√|×
优量汇|√|√|√|√|√|√|√|×
Mobvista|√|√|√|√|√|×|√|×
TopMob|√|√|√|×|√|√|×|×
推啊|×|×|×|×|×|×|×|√
Inmobi|√|×|×|×|×|×|√|×

<h2>一、SDK接入</h2>  

1、集成Midas广告SDK(暂不支持cocoapods导入)  

第一步：导入Midas聚合SDK和相关的依赖库
![依赖库](https://upload-images.jianshu.io/upload_images/8125173-c0cf13ddc6a91d80.png)

第二步：Xcdoe编译选项设置  
添加权限

* 工程plist文件设置, 添加App Transport Security Settings，将Allow Arbitrary Loads 选项自动加入，修改值为 YES。为了支持当前聚合SDK的广告素材存在非HTTPS情况。   
具体如下图：
![](https://upload-images.jianshu.io/upload_images/8125173-1414e4ea21347d89.png)
* Build Settings中Other Linker Flags 增加参数-ObjC

运行环境配置  

* 支持系统iOS9.0及以上
* SDK编译环境 Xcode 11
* 支持架构：i386 armv7 x86_64 arm64

<h2>二、加载广告</h2> 


管理类目前提供一下几个方法  

	/**
	 * APP的唯一标识
	 */
	+ (NSString *)appId;

	/**
	 * 获取SDK版本
	 */
	+ (NSString *)sdkVersion;

	/**
	  Midas初始化方法
	  @param appId  应用ID
	  @param productId 大数据业务线ID
	  @param serverUrl 大数据埋点地址
	 */
	+ (void)registAppId:(NSString *)appId productId:(NSString *)productId bdServerUrl:(NSString *)serverUrl;

	/**
 	 根据消息体展示对应的广告
 	 @param req 请求的消息体
 	 @param completion 广告结果回调
 	 */
	+ (void)loadMidasAdWithReq:(MidasAdReq *)req completion(MidasAdShowBlock)completion;

使用详情

SDK需要在程序入口初始化  

	[MidasAdSDKManager registAppId:@"xxx" productId:@"xxx" bdServerUrl:@"xxx"];

在需要展示广告的地方调用展示方法(见demo)

	MidasAdReq *adReq = [MidasAdReq new];
	//positionId决定广告类型，更多参数见MidasAdReq类说明
	adReq.positionId = @"";
	[MidasAdSDKManager loadMidasAdWithReq:adReq completion:^(MidasAdRes *adRes, NSError *error) {
        if(error){
            NSLog(@"error:%@", error);
        }else{
            //数据处理，见demo
        }
    }];
	
<h2>三、错误码</h2>
1、SDK错误码

错误码|错误消息|推荐处理方案
---|---|---
200|http通信协议响应成功
201|http通信IO异常
10001|api响应未到达异常
10002|api数据解析异常
10003|策略数据返回为空
10004|策略配置获取异常
10005|穿山甲平台广告返回为空	

2、[穿山甲错误码](https://ad.oceanengine.com/union/media/doc?id=5de4cc6d78c8690012a90aa5)

错误码|错误消息|推荐处理方案
---|---|---
20000|成功
20001|没有合适的广告返回而导致的请求没有填充，偶尔出现属于正常情况。如果出现情况较多或者必现的话，请先检查一下广告尺寸是否填写正确，是否有使用模拟器测试广告，单个设备是否一天请求了大量广告但没有展示或者展示数极低等。排查以上问题依然没有结论可以联系技术支持同学或者提交工单（包含代码位和出现概率以及请求时间）相关同学查明后会做出回复
40000|http content type错误
40001|http request pb错误
40002|source_type=‘app’, 请求app不能为空
40003|source_type=‘wap’, 请求wap不能为空
40004|广告位不能为空
40005|广告位尺寸不能为空
40006|广告位ID不合法
40007|广告数量错误
40008|	图片尺寸错误
40009|媒体ID不合法
40010|媒体类型不合法
40011|广告类型不合法
40012|媒体接入类型不合法，已废弃
40013|代码位id小于9亿，但是adType不是开屏
40014|redirect参数不正确
40015|媒体整改超过期限，请求非法
40016|代码位ID 与应用ID 不匹配或者应用ID 缺失。初始化时需要填写appid，且在activity中需要填写代码位ID。媒体要确保这两个ID填写正确且匹配
40017|媒体接入类型不合法 API/SDK
40018|媒体在平台上录入的包名与项目里的包名不一致
40019|媒体在平台上申请的代码位广告类型和代码中使用的广告类型接口不一致。例如平台上是开屏的广告类型，但是代码中请求的接口是banner或者其他非开屏的广告类型，如果不太清楚不同代码位类型对应的接口，麻烦去查询SDK包里的对接文档
40020|开发注册新上线广告位超出日请求量限制
40021|apk签名sha1值与媒体平台录入不一致
40022|媒体在平台上申请的代码位“是否原生”属性与代码中使用的接口不匹配<br>1. 媒体在平台上选择的是个性化模板banner广告的话，Android代码中请参考BannerExpressActivity进行调用；iOS代码中请参考BUDExpressBannerViewController进行调用<br>2. 媒体在平台上选择的是个性化模板插屏广告的话，代码中请参考InteractionExpressActivity进行调用；iOS代码位中请参考BUDExpressInterstitialViewController进行调用
40023|os字段填的不对
40024|sdk 版本过低不返回广告
40025|渲染异常，iOS版本，媒体使用2100之前的版本可能渲染异常，请媒体更新到最新版本接入即可解决该问题
40026|使用海外ip请求国内服务器导致，请确认使用的是国内ip请求广告
40028|ios老设备（涉及设备 iPad 4G/iPad 3G/iPhone 5/iPhone 5C/iPad Mini 1G/iPad 2G/iPhone 4S）被屏蔽，会不返回广告。在2310版本后放开了限制，媒体可以更新到2310或者之后的版本
40029|两种情况：<br>1. SDK版本低；使用的sdk版本过低，还不支持个性化模板渲染功能。解决办法：升级到平台最新版本sdk。<br>2. 接口使用错误；创建的代码位类型是模板渲染/非模板渲染，但是请求方法是非模板渲染/模板渲染的方法。解决办法：使用模板渲染的方法去请求模板渲染类型或者使用非模板渲染的方法去请求非模板类型的广告，如果代码位在平台上是模板渲染，可以参考文档中个性化模板XX广告的部分，demo中参考带有express部分的代码。如果代码位不是模板渲染，则不要调用含有express字样的接口。
50001|服务器错误
60001|show event处理错误
60002|click event处理错误
60007|激励视频验证服务器异常或处理失败
-1|数据解析失败。客户端代码问题的合集,可查看[更多](https://ad.oceanengine.com/union/media/doc?id=5de4cc6d78c8690012a90aa5)
-2|网络错误
-3|解析数据没有ad
-4|返回数据缺少必要字段
-5|bannerAd加载图片失败
-6|插屏广告图片加载失败
-7|开屏广告图片加载失败
-8|频繁请求
-9|请求实体为空
-10|缓存解析失败
-11|缓存过期
-12|缓存中没有开屏广告
101|渲染结果数据解析失败
102|未匹配到主模板：主模板没有下载到本地导致。偶发在首次请求广告时属于正常情况
103|未匹配到子模板：偶发在接入初期，没有匹配到模板导致。待sdk将模板下载成功后不会出现
104|物料数据异常
105|模板数据解析异常
106|渲染异常
107|模板渲染超时未回调，可能原因有<br>1. 网络原因或者<br>2. 硬件原因，因此导致渲染失败，可以更换手机或者网络环境测试

3、[优量汇错误码](https://developers.adnet.qq.com/doc/ios/union/union_debug#%E9%94%99%E8%AF%AF%E7%A0%81)

错误码|错误消息|推荐处理方案
---|---|---
3001|网络异常|
3003|手机无网络|
4001|初始化错误, 包括广告位为空、AppKey为空、ViewController
为空|
4003|广告位错误|
4006|广告未曝光|
4007|设备不支持|
4008|设备方向不支持|
4009|开屏跳过按钮定义非法|
4010|开屏bottomView设置非法|
4011|请求广告超时|
4013|系统不支持，原生视频模板广告只支持 iOS 9 及以上系统|
4014|广告数据返回前尝试展示广告, 例如激励视频拉到广告后才可以调用展示接口|
4015|广告已经曝光过，不允许二次展示，请重新拉取|
4016|应用横竖方向与广告位支持方向不匹配|
4017|外部传入的VC无效|
4018|缓存文件在流程中被意外删除|
4019|开屏广告 rootViewController presentVC 被占用|
5001|后台数据错误|
5002|视频素材下载错误|
5003|视频素材播放错误|
5004|没匹配的广告，禁止重试，否则影响流量变现效果|
5005|广告请求量或者消耗等超过日限额，请第二天再请求广告|
5006|包名校验非法|
5009|广告请求量或者消耗等超过小时限额，请一小时后再请求广告|
5010|广告样式校验失败，请检查广告位与接口使用是否一致| 
5012|广告过期，请重新拉取| 
5013|广告拉取过于频繁，请稍后再试|
5014|视频广告视频和图片素材都下载错误|
5015|当前版本不出广告|
5016|JSON数据解析失败|
5017|adCount参数非法| 
5018|广告位下线| 
5019|视频时长超过设定时长|
5020|视频URL为空| 
6000|未知错误，联系腾讯广告商务同事协助排查|
